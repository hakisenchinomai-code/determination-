local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local lp = LocalPlayer

if CoreGui:FindFirstChild("Undertale_Rework_UI") then
    CoreGui.Undertale_Rework_UI:Destroy()
end

local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = "Undertale_Rework_UI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true 

local function flashRed()
    local flash = Instance.new("Frame", gui)
    flash.Size = UDim2.new(1, 0, 1, 0)
    flash.BackgroundColor3 = Color3.new(1, 0, 0)
    flash.BackgroundTransparency = 0.3
    flash.ZIndex = 100
    TweenService:Create(flash, TweenInfo.new(0.4), {BackgroundTransparency = 1}):Play()
    task.delay(0.4, function() flash:Destroy() end)
end

local charaGui = Instance.new("Frame", gui)
charaGui.Size = UDim2.new(1, 0, 1, 0)
charaGui.BackgroundTransparency = 1
charaGui.Visible = false

local function createCorner(pos, anchor, rot)
    local frame = Instance.new("Frame", charaGui)
    frame.Size = UDim2.new(0.5, 0, 0.5, 0)
    frame.Position = pos
    frame.AnchorPoint = anchor
    frame.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    frame.BackgroundTransparency = 0.85
    frame.BorderSizePixel = 0
    frame.ZIndex = 5
    local grad = Instance.new("UIGradient", frame)
    grad.Color = ColorSequence.new{ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)), ColorSequenceKeypoint.new(1, Color3.new(0, 0, 0))}
    grad.Transparency = NumberSequence.new{NumberSequenceKeypoint.new(0, 0), NumberSequenceKeypoint.new(1, 1)}
    grad.Rotation = rot
    return frame
end

local corners = {
    createCorner(UDim2.new(0,0,0,0), Vector2.new(0,0), 45),
    createCorner(UDim2.new(1,0,0,0), Vector2.new(1,0), 135),
    createCorner(UDim2.new(0,0,1,0), Vector2.new(0,1), -45),
    createCorner(UDim2.new(1,0,1,0), Vector2.new(1,1), -135),
}

task.spawn(function()
    while true do
        if charaGui.Visible then
            for _,c in pairs(corners) do 
                TweenService:Create(c, TweenInfo.new(0.7, Enum.EasingStyle.Sine), {BackgroundTransparency = 0.6}):Play() 
            end
            task.wait(0.7)
            for _,c in pairs(corners) do 
                TweenService:Create(c, TweenInfo.new(0.7, Enum.EasingStyle.Sine), {BackgroundTransparency = 0.9}):Play() 
            end
            task.wait(0.7)
        else task.wait(0.5) end
    end
end)

task.spawn(function()
    while true do
        if charaGui.Visible then
            local size = math.random(3,12)
            local dot = Instance.new("Frame", charaGui)
            dot.Size = UDim2.new(0,size,0,size); dot.Position = UDim2.new(math.random(),0,1,0)
            dot.BackgroundColor3 = Color3.fromRGB(255,0,0); dot.BorderSizePixel = 0; dot.ZIndex = 10
            Instance.new("UICorner", dot).CornerRadius = UDim.new(1,0)
            local tween = TweenService:Create(dot,TweenInfo.new(math.random(3,6)),{
                Position = UDim2.new(dot.Position.X.Scale + (math.random(-10,10)/100), 0, math.random(0.4,0.7), 0),
                BackgroundTransparency = 1
            })
            tween:Play(); tween.Completed:Connect(function() dot:Destroy() end)
            task.wait(0.06)
        else task.wait(0.5) end
    end
end)

-- [THÊM VÀO] HÀM TẠO SÓNG ĐỎ (WAVE EFFECT)
local function createWaveEffect()
    local char = lp.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local part = Instance.new("Part")
    part.Anchored = true; part.CanCollide = false; part.CastShadow = false
    part.Transparency = 1; part.Size = Vector3.new(1, 1, 1); part.Parent = workspace
    
    local mesh = Instance.new("SpecialMesh")
    mesh.MeshId = "rbxassetid://7108020644"; mesh.MeshType = Enum.MeshType.FileMesh; mesh.Parent = part
    part.Material = Enum.Material.Neon; part.Color = Color3.fromRGB(255, 0, 0)

    local currentStuds, maxStuds, speed = 0.1, 12, 25
    local connection
    connection = RunService.RenderStepped:Connect(function(dt)
        if not _G.DeterActive or not hrp or not hrp.Parent or not part.Parent then
            if connection then connection:Disconnect() end
            part:Destroy(); return
        end
        part.Position = hrp.Position - Vector3.new(0, 2.8, 0)
        currentStuds = currentStuds + (speed * dt)
        local scaleFactor = currentStuds * 0.05 
        mesh.Scale = Vector3.new(scaleFactor, 0.05, scaleFactor)
        part.Transparency = 0.1 + (0.9 * (currentStuds / maxStuds))
        if currentStuds >= maxStuds then connection:Disconnect(); part:Destroy() end
    end)
end

task.spawn(function()
    while true do
        if _G.DeterActive then createWaveEffect() end
        task.wait(0.5)
    end
end)

local function playTalkSound(isEvil)
    local s = Instance.new("Sound", CoreGui)
    s.SoundId = isEvil and "rbxassetid://929615155" or "rbxassetid://929615246"
    s.Volume = 0.6; s:Play()
    s.Ended:Connect(function() s:Destroy() end)
end

local btnClickSound = Instance.new("Sound", gui); btnClickSound.SoundId = "rbxassetid://6856723345"
local saveSound = Instance.new("Sound", gui); saveSound.SoundId = "rbxassetid://135724514015482"
local deathSound = Instance.new("Sound", gui); deathSound.SoundId = "rbxassetid://135209094013497"
local spawnSound = Instance.new("Sound", gui); spawnSound.SoundId = "rbxassetid://87561416369452"

local main = Instance.new("Frame", gui)
main.Size = UDim2.new(0, 600, 0, 160)
main.Position = UDim2.new(0.5, -300, 0.75, -80)
main.BackgroundColor3 = Color3.new(0,0,0); main.BorderColor3 = Color3.new(1,1,1); main.BorderSizePixel = 4
main.Active, main.Draggable = true, true

local closeBtn = Instance.new("TextButton", main)
closeBtn.Size = UDim2.new(0, 30, 0, 30); closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.BackgroundTransparency = 1; closeBtn.Text = "X"; closeBtn.TextColor3 = Color3.new(1,1,1); closeBtn.Font = Enum.Font.Arcade; closeBtn.TextSize = 25

local shrinkBtn = Instance.new("TextButton", main)
shrinkBtn.Size = UDim2.new(0, 30, 0, 30); shrinkBtn.Position = UDim2.new(1, -70, 0, 5)
shrinkBtn.BackgroundTransparency = 1; shrinkBtn.Text = "-"; shrinkBtn.TextColor3 = Color3.new(1,1,1); shrinkBtn.Font = Enum.Font.Arcade; shrinkBtn.TextSize = 35

local miniBtn = Instance.new("ImageButton", gui)
miniBtn.Size = UDim2.new(0, 60, 0, 60); miniBtn.Position = UDim2.new(0, 20, 0.5, -30)
miniBtn.Visible = false; miniBtn.BackgroundColor3 = Color3.new(0,0,0); miniBtn.BorderColor3 = Color3.new(1,1,1); miniBtn.BorderSizePixel = 3
miniBtn.Image = "rbxthumb://type=Asset&id=18938437019&w=420&h=420"
Instance.new("UICorner", miniBtn).CornerRadius = UDim.new(1, 0)
miniBtn.Active, miniBtn.Draggable = true, true

closeBtn.MouseButton1Click:Connect(function() btnClickSound:Play(); gui:Destroy() end)
shrinkBtn.MouseButton1Click:Connect(function() main.Visible = false; miniBtn.Visible = true end)
miniBtn.MouseButton1Click:Connect(function() miniBtn.Visible = false; main.Visible = true end)

local portrait = Instance.new("ImageLabel", main)
portrait.Size = UDim2.new(0, 120, 0, 120); portrait.Position = UDim2.new(0, 20, 0.5, -60); portrait.BackgroundTransparency = 1
portrait.Image = "rbxthumb://type=Asset&id=102826797353578&w=420&h=420"

local statusText = Instance.new("TextLabel", main)
statusText.Size = UDim2.new(0, 420, 0, 100); statusText.Position = UDim2.new(0, 155, 0.5, -65); statusText.BackgroundTransparency = 1
statusText.TextColor3 = Color3.new(1,1,1); statusText.Font = Enum.Font.Arcade; statusText.TextSize = 22
statusText.TextXAlignment = Enum.TextXAlignment.Left; statusText.TextYAlignment = Enum.TextYAlignment.Top; statusText.TextWrapped = true

local EspActive = false
_G.DeterActive = false
local currentTalkId = 0
local innerRange = 7
local outerRange = 12
local shakeConnection = nil

local function stopShake()
    if shakeConnection then shakeConnection:Disconnect(); shakeConnection = nil end
    statusText.Position = UDim2.new(0, 155, 0.5, -65)
end

local function startShake()
    stopShake()
    shakeConnection = RunService.RenderStepped:Connect(function()
        local ox = math.random(-2, 2); local oy = math.random(-2, 2)
        statusText.Position = UDim2.new(0, 155 + ox, 0.5, -65 + oy)
    end)
end

local function CreateUTButton(name, pos, checkVarFunc)
    local btn = Instance.new("TextButton", main)
    btn.Size = UDim2.new(0, 230, 0, 40); btn.Position = pos; btn.BackgroundTransparency = 1
    btn.Text = "      " .. name; btn.TextColor3 = Color3.new(1, 1, 1); btn.Font = Enum.Font.Arcade; btn.TextSize = 20
    btn.TextXAlignment = Enum.TextXAlignment.Left; btn.Visible = false
    local soulIcon = Instance.new("ImageLabel", btn)
    soulIcon.Size = UDim2.new(0, 22, 0, 22); soulIcon.Position = UDim2.new(0, 5, 0.5, -11)
    soulIcon.BackgroundTransparency = 1; soulIcon.Image = "rbxthumb://type=Asset&id=127269861215079&w=420&h=420"
    soulIcon.ImageTransparency = 1
    btn.MouseEnter:Connect(function() btnClickSound:Play(); soulIcon.ImageTransparency = 0; btn.TextColor3 = Color3.new(1, 1, 0) end)
    btn.MouseLeave:Connect(function() soulIcon.ImageTransparency = 1; if not checkVarFunc() then btn.TextColor3 = Color3.new(1, 1, 1) end end)
    return btn
end

local espBtn = CreateUTButton("PLAYER ESP", UDim2.new(0, 155, 0.7, 0), function() return EspActive end)
local deterBtn = CreateUTButton("DETERMINATION", UDim2.new(0, 360, 0.7, 0), function() return _G.DeterActive end)

local function typeWrite(txt, evilMode, showButtons)
    currentTalkId = currentTalkId + 1
    local myId = currentTalkId
    stopShake()
    statusText.Text = ""
    statusText.TextColor3 = evilMode and Color3.new(1, 0, 0) or Color3.new(1, 1, 1)
    portrait.Image = evilMode and "rbxthumb://type=Asset&id=90345918387121&w=420&h=420" or "rbxthumb://type=Asset&id=102826797353578&w=420&h=420"
    if evilMode then startShake() end
    for i = 1, #txt do
        if myId ~= currentTalkId then return end
        statusText.Text = string.sub(txt, 1, i)
        playTalkSound(evilMode); task.wait(evilMode and 0.05 or 0.03)
    end
    if showButtons and myId == currentTalkId then espBtn.Visible, deterBtn.Visible = true, true end
end

espBtn.MouseButton1Click:Connect(function()
    EspActive = not EspActive
    espBtn.TextColor3 = EspActive and Color3.new(1, 1, 0) or Color3.new(1, 1, 1)
    typeWrite(EspActive and "* No one can hide." or "* You are no longer just a player.", EspActive)
end)

deterBtn.MouseButton1Click:Connect(function()
    _G.DeterActive = not _G.DeterActive
    if _G.DeterActive then flashRed(); task.wait(0.05) end
    charaGui.Visible = _G.DeterActive
    deterBtn.TextColor3 = _G.DeterActive and Color3.new(1, 1, 0) or Color3.new(1, 1, 1)
    if _G.DeterActive then typeWrite("* Determination surges through your veins.", true)
    else typeWrite("* The determination fades away.", false) end
end)

local function add_esp(p)
    if p == lp then return end
    local function apply(char)
        local highlight = Instance.new("Highlight")
        local bill = Instance.new("BillboardGui")
        bill.Size, bill.AlwaysOnTop, bill.StudsOffset = UDim2.new(0, 100, 0, 40), true, Vector3.new(0, 3, 0)
        local lab = Instance.new("TextLabel", bill)
        lab.Size, lab.BackgroundTransparency, lab.Font, lab.TextSize = UDim2.new(1, 0, 1, 0), 1, Enum.Font.SourceSansBold, 14
        RunService.RenderStepped:Connect(function()
            if not char.Parent or not gui.Parent then highlight:Destroy(); bill:Destroy(); return end
            local root = char:FindFirstChild("HumanoidRootPart")
            if EspActive and root and lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
                highlight.Parent = char; bill.Parent = char:FindFirstChild("Head") or root
                local tColor = p.TeamColor and p.TeamColor.Color or Color3.new(1, 1, 1)
                highlight.FillColor, lab.TextColor3 = tColor, tColor
                lab.Text = p.Name .. "\n" .. math.floor((lp.Character.HumanoidRootPart.Position - root.Position).Magnitude) .. "m"
                highlight.Enabled, bill.Enabled = true, true
            else highlight.Enabled, bill.Enabled = false, false end
        end)
    end
    if p.Character then apply(p.Character) end; p.CharacterAdded:Connect(apply)
end
for _, v in pairs(Players:GetPlayers()) do add_esp(v) end; Players.PlayerAdded:Connect(add_esp)

local function CreateAuraPart(color, range)
    local p = Instance.new("Part", workspace); p.Anchored, p.CanCollide = true, false; p.Transparency = 1
    p.Shape = "Cylinder"; p.Material = "ForceField"; p.Color = color
    p.Size = Vector3.new(0.08, range * 2, range * 2); return p
end

local InnerCircle = CreateAuraPart(Color3.fromRGB(255, 0, 0), innerRange)
local OuterRing = CreateAuraPart(Color3.fromRGB(255, 50, 50), outerRange)
local SoulBase = Instance.new("Part", workspace); SoulBase.Anchored, SoulBase.CanCollide = true, false; SoulBase.Transparency = 1
local SoulMesh = Instance.new("SpecialMesh", SoulBase); SoulMesh.MeshId = "rbxassetid://18142689519"; SoulMesh.Scale = Vector3.new(0.012, 0.012, 0.012)
SoulBase.Color, SoulBase.Material = Color3.new(1,0,0), "Neon"

local hasPlayedDeathSound, isFirstLoad, hasPlayedSpawnSound = true, true, false
RunService.RenderStepped:Connect(function()
    local char = lp.Character; local root = char and char:FindFirstChild("HumanoidRootPart")
    if root and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
        if isFirstLoad or hasPlayedDeathSound then saveSound:Play(); isFirstLoad, hasPlayedDeathSound = false, false end
        local posBase = root.CFrame * CFrame.Angles(0, 0, math.rad(90)) + Vector3.new(0, -2.85, 0)
        InnerCircle.CFrame, OuterRing.CFrame = posBase, posBase
        SoulBase.CFrame = root.CFrame * CFrame.new(0, 0.5 + math.sin(tick()*3)*0.3, -0.8) * CFrame.Angles(0, math.rad(180), 0)
        InnerCircle.Transparency = _G.DeterActive and 0.4 or 1
        OuterRing.Transparency = _G.DeterActive and 0.8 or 1
        SoulBase.Transparency = _G.DeterActive and 0 or 1
        if _G.DeterActive then
            if not hasPlayedSpawnSound then spawnSound:Play(); hasPlayedSpawnSound = true end
            local tool = char:FindFirstChildOfClass("Tool")
            if tool then
                local h = tool:FindFirstChild("Handle") or tool:FindFirstChildOfClass("Part")
                for _, enemy in pairs(Players:GetPlayers()) do
                    if enemy ~= lp and enemy.Character and enemy.Character:FindFirstChild("HumanoidRootPart") then
                        local dist = (root.Position - enemy.Character.HumanoidRootPart.Position).Magnitude
                        if dist <= innerRange then
                            tool:Activate()
                            for i = 1, 15 do firetouchinterest(enemy.Character.HumanoidRootPart, h, 0); firetouchinterest(enemy.Character.HumanoidRootPart, h, 1) end
                        elseif dist <= outerRange then
                            tool:Activate()
                            firetouchinterest(enemy.Character.HumanoidRootPart, h, 0); firetouchinterest(enemy.Character.HumanoidRootPart, h, 1)
                        end
                    end
                end
            end
        else hasPlayedSpawnSound = false end
    else
        if not hasPlayedDeathSound then deathSound:Play(); hasPlayedDeathSound = true; hasPlayedSpawnSound = false end
        InnerCircle.Transparency, OuterRing.Transparency, SoulBase.Transparency = 1, 1, 1
    end
end)

task.spawn(function()
    typeWrite("* Greetings, fallen human. This script was made by 美好的回忆一个异常安静的空间.", false)
    task.wait(1.5)
    typeWrite("* Someone is messing with the system just to use this...", true)
    task.wait(1.8)
    typeWrite("* You are no longer just a player.", false, true)
end)

